<div class="container py-5">

  <h2 class="mb-4">Carga Derivados Manual</h2>

  <!-- Zona Drag & Drop -->
  <div *ngIf="newFichaDerivado.relaciones.length === 0; else dataPreview"
       class="drag-drop-area"
       (drop)="onDrop($event)"
       (dragover)="onDragOver($event)"
       (dragleave)="onDragLeave($event)">

    <div class="file-upload text-center">
      <input type="file"
             (change)="onFileSelected($event)"
             accept=".xlsx"
             hidden
             #fileInput>

      <p class="mb-3">Selecciona un archivo Excel válido (.xlsx) de hasta 10MB</p>

      <button mat-raised-button color="primary"
              (click)="fileInput.click()"
              [disabled]="isLoadingFile">
        <mat-icon>upload</mat-icon> Seleccionar archivo
      </button>

      <div class="mt-2">
        <small>o arrastra tu archivo aquí</small>
      </div>
    </div>
  </div>

  <!-- Vista previa -->
  <ng-template #dataPreview>
    <div class="my-4">
      <h5>Datos cargados desde Excel</h5>
      <p><strong>Fecha de carga:</strong> {{ newFichaDerivado.fechaCarga }}</p>

      <!-- Tabla Angular Material -->
      <div class="mat-elevation-z2">
        <table mat-table [dataSource]="newFichaDerivado.relaciones" class="full-width-table">

          <!-- Tipo Identificación -->
          <ng-container matColumnDef="tipoIdentificacion">
            <th mat-header-cell *matHeaderCellDef> Tipo Identificación </th>
            <td mat-cell *matCellDef="let element"
                [ngClass]="{'duplicado-row': element.duplicado}">
              {{element.tipoIdentificacion}}
            </td>
          </ng-container>

          <!-- Exposición -->
          <ng-container matColumnDef="exposicion">
            <th mat-header-cell *matHeaderCellDef> Exposición </th>
            <td mat-cell *matCellDef="let element"
                [ngClass]="{'duplicado-row': element.duplicado}">
              {{element.exposicion}}
            </td>
          </ng-container>

          <!-- Fecha Operación -->
          <ng-container matColumnDef="fechaOperacion">
            <th mat-header-cell *matHeaderCellDef> Fecha Operación </th>
            <td mat-cell *matCellDef="let element"
                [ngClass]="{'duplicado-row': element.duplicado}">
              {{element.fechaOperacion}}
            </td>
          </ng-container>

          <!-- Fecha Carga -->
          <ng-container matColumnDef="fechaCarga">
            <th mat-header-cell *matHeaderCellDef> Fecha Carga </th>
            <td mat-cell *matCellDef="let element"
                [ngClass]="{'duplicado-row': element.duplicado}">
              {{element.fechaCarga}}
            </td>
          </ng-container>

          <!-- Header y Rows -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [ngClass]="{'duplicado-row': row.duplicado}">
          </tr>
        </table>
      </div>

      <!-- Botones -->
      <div class="d-flex gap-3 mt-4">
        <button mat-raised-button color="warn" (click)="reset()">
          <mat-icon>cancel</mat-icon> Cancelar cambios
        </button>

        <button mat-raised-button color="accent"
                (click)="storeNewFactSheet()"
                [disabled]="storeNewFactSheetIsLoading">
          <mat-icon>save</mat-icon>
          Guardar Derivados
        </button>
      </div>
    </div>
  </ng-template>

</div>

